<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Console JWT | ApiMercado</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root {
            --bg: #070a14;
            --surface: #101828;
            --surface-2: #111b2f;
            --border: #1d2942;
            --accent: #2563eb;
            --accent-soft: rgba(37, 99, 235, 0.15);
            --text: #f8fafc;
            --muted: #94a3b8;
            font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        }
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            background: radial-gradient(circle at top, rgba(37, 99, 235, 0.25), transparent 55%), var(--bg);
            color: var(--text);
        }
        .hero {
            padding: 3.5rem 1.5rem 2rem;
            text-align: center;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.25), rgba(147, 51, 234, 0.15));
            border-bottom: 1px solid var(--border);
        }
        .hero-content {
            max-width: 960px;
            margin: 0 auto;
        }
        .hero .eyebrow {
            text-transform: uppercase;
            letter-spacing: 0.3em;
            font-size: 0.75rem;
            color: var(--muted);
        }
        .hero h1 {
            margin: 0.5rem 0;
            font-size: clamp(2rem, 4vw, 3rem);
        }
        .hero p {
            margin: 0 auto 1.5rem;
            max-width: 640px;
            color: var(--muted);
        }
        .hero-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        button, .btn {
            border: none;
            border-radius: 999px;
            padding: 0.8rem 1.4rem;
            background: var(--accent);
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.15s ease, transform 0.15s ease;
        }
        button.secondary, .btn.secondary {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        button:hover:not(:disabled), .btn:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .container {
            max-width: 1100px;
            margin: -2rem auto 4rem;
            padding: 0 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.75rem;
        }
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 1.75rem;
            box-shadow: 0 20px 55px rgba(7, 10, 20, 0.56);
        }
        .section-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .section-title h2 {
            margin: 0;
            font-size: 1.35rem;
        }
        .pill {
            padding: 0.2rem 0.7rem;
            border-radius: 999px;
            background: var(--accent-soft);
            color: var(--accent);
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.05em;
        }
        label {
            font-size: 0.9rem;
            color: var(--muted);
            display: block;
            margin-bottom: 0.35rem;
        }
        input, select {
            width: 100%;
            padding: 0.75rem 0.9rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--surface-2);
            color: var(--text);
            font-size: 1rem;
        }
        .form-grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }
        .form-grid .full {
            grid-column: 1 / -1;
        }
        .token-panel {
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.25rem;
        }
        .token-panel h3 {
            margin: 0 0 0.5rem;
        }
        .token-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        .helper-text {
            font-size: 0.85rem;
            color: var(--muted);
            margin-top: 0.25rem;
        }
        .products-grid {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }
        .list-panel {
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.25rem;
        }
        .products-list {
            list-style: none;
            padding: 0;
            margin: 1rem 0 0;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }
        .products-list li {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.75rem;
            display: flex;
            justify-content: space-between;
            gap: 1rem;
        }
        .products-list strong {
            font-size: 1rem;
        }
        .muted {
            color: var(--muted);
            font-size: 0.85rem;
        }
        @media (max-width: 640px) {
            .card {
                padding: 1.2rem;
            }
            .hero-actions {
                flex-direction: column;
            }
        }
        .toast {
            position: fixed;
            right: 1.5rem;
            bottom: 1.5rem;
            padding: 1rem 1.25rem;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            background: var(--surface);
            box-shadow: 0 20px 45px rgba(0,0,0,0.35);
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.25s ease, transform 0.25s ease;
            pointer-events: none;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success { border-color: rgba(16,185,129,0.4); }
        .toast.error { border-color: rgba(239,68,68,0.4); }
        .toast.info { border-color: rgba(59,130,246,0.4); }
    </style>
</head>
<body>
<header class="hero">
    <div class="hero-content">
        <p class="eyebrow">ApiMercado</p>
        <h1>Console de testes JWT</h1>
        <p>Gerencie contas, tokens e endpoints protegidos sem sair do navegador. Tudo em HTML, CSS e JS puros.</p>
        <div class="hero-actions">
            <button data-scroll="#register-section">Cadastrar usuário</button>
            <button class="secondary" data-scroll="#login-section">Fazer login</button>
        </div>
    </div>
</header>

<main class="container">
    <section class="card" id="config-section">
        <div class="section-title">
            <span class="pill">Configuração</span>
            <h2>Defina o endpoint base</h2>
        </div>
        <label for="base-url">Base URL da API</label>
        <input id="base-url" type="text" value="http://localhost:8080" spellcheck="false">
        <p class="helper-text">A URL é reutilizada em todas as requisições. Ajuste se o backend estiver exposto em outra porta ou host.</p>
    </section>

    <section class="card" id="register-section">
        <div class="section-title">
            <span class="pill">Sessão 01</span>
            <h2>Registrar novo usuário</h2>
        </div>
        <form id="register-form" class="form-grid">
            <div class="full">
                <label for="reg-fullname">Nome completo</label>
                <input id="reg-fullname" name="fullname" placeholder="Maria Silva" required>
            </div>
            <div>
                <label for="reg-username">Username</label>
                <input id="reg-username" name="username" placeholder="maria.silva" required>
            </div>
            <div>
                <label for="reg-password">Senha</label>
                <input id="reg-password" name="password" type="password" placeholder="••••••••" required>
            </div>
            <div>
                <label for="reg-role">Perfil</label>
                <select id="reg-role" name="role">
                    <option value="ROLE_USER">ROLE_USER</option>
                    <option value="ROLE_ADMIN">ROLE_ADMIN</option>
                </select>
            </div>
            <div class="full">
                <button type="submit">Registrar usuário</button>
            </div>
        </form>
    </section>

    <section class="card" id="login-section">
        <div class="section-title">
            <span class="pill">Sessão 02</span>
            <h2>Login e geração de tokens</h2>
        </div>
        <form id="login-form" class="form-grid">
            <div>
                <label for="login-username">Username</label>
                <input id="login-username" name="username" placeholder="maria.silva" required>
            </div>
            <div>
                <label for="login-password">Senha</label>
                <input id="login-password" name="password" type="password" placeholder="••••••••" required>
            </div>
            <div class="full">
                <button type="submit">Entrar e gerar tokens</button>
            </div>
        </form>
    </section>

    <section class="card" id="token-section">
        <div class="section-title">
            <span class="pill">Sessão 03</span>
            <h2>Gerenciamento de tokens</h2>
        </div>
        <div class="token-panel">
            <h3>Status dos tokens</h3>
            <p id="token-status" class="helper-text" style="margin-bottom: 0.25rem;">Nenhum token ativo.</p>
            <p class="helper-text">Os tokens são armazenados apenas na memória desta página e não são exibidos aqui.</p>
            <div class="token-actions">
                <button id="refresh-btn" class="btn secondary" disabled>Gerar novo access via refresh token</button>
                <button id="logout-btn" class="btn secondary" disabled>Encerrar sessão</button>
            </div>
        </div>
    </section>

    <section class="card" id="products-section">
        <div class="section-title">
            <span class="pill">Sessão 04</span>
            <h2>Produtos protegidos por JWT</h2>
        </div>
        <div class="products-grid">
            <div class="list-panel">
                <div class="section-title" style="margin-bottom: 0.5rem;">
                    <span class="pill">GET /products</span>
                    <h3 style="margin:0;">Inventário atual</h3>
                </div>
                <button id="list-products" class="secondary" style="width: 100%;">Atualizar lista</button>
                <ul id="products-list" class="products-list">
                    <li class="muted">Clique em “Atualizar lista” para carregar.</li>
                </ul>
            </div>
            <div class="list-panel">
                <div class="section-title" style="margin-bottom: 0.5rem;">
                    <span class="pill">POST /products</span>
                    <h3 style="margin:0;">Novo produto</h3>
                </div>
                <form id="create-product-form" class="form-grid">
                    <div class="full">
                        <label for="prod-name">Nome</label>
                        <input id="prod-name" name="name" placeholder="Café especial" required>
                    </div>
                    <div class="full">
                        <label for="prod-price">Preço</label>
                        <input id="prod-price" name="price" type="number" min="0" step="0.01" placeholder="49.90" required>
                    </div>
                    <div class="full">
                        <button type="submit">Salvar produto</button>
                    </div>
                </form>
            </div>
        </div>
    </section>

</main>

<div id="toast" class="toast info"></div>

<script>
    const state = {
        accessToken: null,
        refreshToken: null,
    };

    const dom = {
        baseUrlInput: document.getElementById('base-url'),
        registerForm: document.getElementById('register-form'),
        loginForm: document.getElementById('login-form'),
        refreshBtn: document.getElementById('refresh-btn'),
        logoutBtn: document.getElementById('logout-btn'),
        listProductsBtn: document.getElementById('list-products'),
        createProductForm: document.getElementById('create-product-form'),
        productsList: document.getElementById('products-list'),
        tokenStatus: document.getElementById('token-status'),
        toast: document.getElementById('toast')
    };

    document.querySelectorAll('[data-scroll]').forEach((btn) => {
        btn.addEventListener('click', () => {
            const target = document.querySelector(btn.dataset.scroll);
            target?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
    });

    function notify(message, type = 'info') {
        dom.toast.textContent = message;
        dom.toast.className = `toast show ${type}`;
        clearTimeout(dom.toast.timeoutId);
        dom.toast.timeoutId = setTimeout(() => {
            dom.toast.classList.remove('show');
        }, 3200);
    }

    function updateTokenStatus() {
        const hasAccess = Boolean(state.accessToken);
        const hasRefresh = Boolean(state.refreshToken);
        dom.tokenStatus.textContent = hasAccess
            ? (hasRefresh ? 'Tokens ativos e prontos para uso.' : 'Access token ativo, mas sem refresh disponível.')
            : 'Nenhum token ativo.';
        dom.refreshBtn.disabled = !hasRefresh;
        dom.logoutBtn.disabled = !hasAccess && !hasRefresh;
    }

    function captureTokens(responseBody) {
        if (!responseBody || typeof responseBody !== 'object') {
            return;
        }
        const accessCandidate = responseBody.acessToken || responseBody.accessToken;
        if (accessCandidate) {
            state.accessToken = accessCandidate;
        }
        if (responseBody.refreshToken) {
            state.refreshToken = responseBody.refreshToken;
        }
        updateTokenStatus();
    }

    function getBaseUrl() {
        return dom.baseUrlInput.value.replace(/\/$/, '');
    }

    async function callApi(path, { method = 'GET', body, auth = false } = {}) {
        const headers = { 'Content-Type': 'application/json' };
        if (auth && state.accessToken) {
            headers.Authorization = `Bearer ${state.accessToken}`;
        }
        const response = await fetch(`${getBaseUrl()}${path}`, {
            method,
            headers,
            body: body ? JSON.stringify(body) : undefined,
        });
        const isJson = response.headers.get('content-type')?.includes('application/json');
        const data = isJson ? await response.json() : await response.text();
        if (!response.ok) {
            throw { status: response.status, body: data };
        }
        captureTokens(data);
        return data;
    }

    dom.registerForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const body = Object.fromEntries(new FormData(event.target).entries());
        try {
            await callApi('/auth/register', { method: 'POST', body });
            notify('Usuário registrado com sucesso', 'success');
            event.target.reset();
        } catch (error) {
            notify('Erro ao registrar usuário', 'error');
        }
    });

    dom.loginForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const body = Object.fromEntries(new FormData(event.target).entries());
        try {
            await callApi('/auth/login', { method: 'POST', body });
            notify('Login realizado e tokens armazenados', 'success');
        } catch (error) {
            notify('Erro no login', 'error');
        }
    });

    dom.refreshBtn.addEventListener('click', async () => {
        if (!state.refreshToken) {
            notify('Nenhum refresh token disponível', 'info');
            return;
        }
        try {
            await callApi('/auth/refresh-token', {
                method: 'POST',
                body: { refreshToken: state.refreshToken },
            });
            notify('Access token renovado', 'success');
        } catch (error) {
            notify('Erro ao renovar token', 'error');
        }
    });

    dom.logoutBtn.addEventListener('click', () => {
        state.accessToken = null;
        state.refreshToken = null;
        updateTokenStatus();
        notify('Sessão encerrada, tokens removidos.', 'info');
    });

    function ensureAuthAvailable(action) {
        if (!state.accessToken) {
            notify('Faça login para acessar esta ação protegida.', 'info');
            return false;
        }
        return true;
    }

    dom.listProductsBtn.addEventListener('click', async () => {
        if (!ensureAuthAvailable()) {
            return;
        }
        try {
            const data = await callApi('/products', { auth: true });
            renderProducts(data);
            notify('Produtos carregados', 'success');
        } catch (error) {
            renderProducts();
            notify('Erro ao listar produtos', 'error');
        }
    });

    function renderProducts(products) {
        if (!Array.isArray(products) || products.length === 0) {
            dom.productsList.innerHTML = '<li class="muted">Nenhum produto encontrado.</li>';
            return;
        }
        dom.productsList.innerHTML = products.map((product) => {
            const price = product.price ?? product.preco;
            return `<li><strong>${product.name ?? product.nome}</strong><span>R$ ${Number(price).toFixed(2)}</span></li>`;
        }).join('');
    }

    dom.createProductForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!ensureAuthAvailable()) {
            return;
        }
        const formData = new FormData(event.target);
        const body = {
            name: formData.get('name'),
            price: parseFloat(formData.get('price')),
        };
        try {
            await callApi('/products', { method: 'POST', body, auth: true });
            notify('Produto criado com sucesso', 'success');
            event.target.reset();
            dom.listProductsBtn.click();
        } catch (error) {
            notify('Erro ao criar produto', 'error');
        }
    });

    updateTokenStatus();
</script>
</body>
</html>
